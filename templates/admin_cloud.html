<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>{{ brand_name }} — Cloud Admin</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#0f172a; --grad1:#111827; --grad2:#0b1220;
      --card:#0b1324; --ink:#e5e7eb; --muted:#94a3b8; --line:#1f2a44;
      --brand:#22d3ee; --good:#10b981; --bad:#ef4444; --warn:#f59e0b; --btn:#2563eb;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--ink); font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(1200px 1200px at 10% -10%, #143, transparent 35%),
        radial-gradient(800px 800px at 110% -10%, #123, transparent 35%),
        linear-gradient(160deg, var(--grad1), var(--grad2));
    }
    a{color:inherit;text-decoration:none}
    header{
      position:sticky; top:0; z-index:10; backdrop-filter:saturate(150%) blur(8px);
      background:linear-gradient(to bottom, rgba(10,16,28,.85), rgba(10,16,28,.55));
      border-bottom:1px solid var(--line)
    }
    .wrap{max-width:1100px;margin:0 auto;padding:16px 20px}
    .row{display:flex; align-items:center; gap:12px; justify-content:space-between}
    .brand{display:flex; align-items:center; gap:10px}
    .logo{width:36px;height:36px;border-radius:10px;
      background:conic-gradient(from 220deg,#22d3ee,#60a5fa,#a78bfa,#22d3ee);
      box-shadow:0 4px 18px rgba(34,211,238,.35)}
    h1{font-size:18px;margin:0;font-weight:700;letter-spacing:.2px}
    .controls{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .seg{display:inline-flex;padding:4px;background:#0a1221;border:1px solid var(--line);border-radius:12px}
    .seg a{padding:6px 10px;border-radius:8px;color:var(--muted)}
    .seg a.active{background:rgba(37,99,235,.15);color:#cfe0ff;border:1px solid rgba(37,99,235,.35)}
    .search{display:flex; align-items:center; gap:8px; border:1px solid var(--line); background:#0a1221; border-radius:10px; padding:6px 10px; min-width:220px}
    .search input{background:transparent;border:0;outline:0;color:var(--ink);width:170px}
    .search svg{opacity:.7}
    .link{padding:6px 10px;border-radius:8px;border:1px solid var(--line);background:#0a1221}
    .stats{max-width:1100px;margin:16px auto 0; padding:0 20px;
      display:grid; grid-template-columns:repeat(4,minmax(0,1fr)); gap:12px}
    .card{background:linear-gradient(180deg, rgba(17,25,43,.85), rgba(11,18,32,.85));
      border:1px solid var(--line); border-radius:14px; padding:14px 16px; box-shadow:0 6px 20px rgba(0,0,0,.25)}
    .card h3{margin:0 0 4px;font-size:12px;color:var(--muted);font-weight:600;letter-spacing:.4px;text-transform:uppercase}
    .card .num{font-size:22px;font-weight:800}
    @media (max-width:900px){ .stats{grid-template-columns:repeat(2,1fr)} }
    @media (max-width:560px){ .stats{grid-template-columns:1fr} }

    main{max-width:1100px;margin:14px auto 40px; padding:0 20px}
    .table{width:100%; border-collapse:collapse; background:var(--card);
      border:1px solid var(--line); border-radius:14px; overflow:hidden;
      box-shadow:0 10px 24px rgba(0,0,0,.22)}
    th, td{padding:12px 14px; border-bottom:1px solid var(--line); text-align:left}
    thead th{font-size:12px; letter-spacing:.4px; text-transform:uppercase; color:#cbd5e1; background:#0b152a;
      position:relative; user-select:none; cursor:pointer}
    thead th .sort{opacity:.5; margin-left:6px}
    tbody tr{transition:background .15s ease}
    tbody tr:hover{background:#0b152a}
    tbody tr:last-child td{border-bottom:0}
    .muted{color:var(--muted)}
    .badge{padding:3px 10px; border-radius:999px; font-size:12px; border:1px solid transparent;
      background:rgba(37,99,235,.12); color:#cfe0ff; border-color:rgba(37,99,235,.25)}
    .badge.cancelled{background:rgba(239,68,68,.12); color:#fecaca; border-color:rgba(239,68,68,.35)}
    .badge.completed{background:rgba(16,185,129,.12); color:#bbf7d0; border-color:rgba(16,185,129,.35)}
    .actions{display:flex; gap:8px}
    .btn{border:1px solid transparent; background:#0e1a33; color:#dbeafe; padding:7px 10px; border-radius:10px;
      cursor:pointer; font-weight:600; transition:transform .02s ease, background .15s ease, border-color .15s ease}
    .btn:hover{background:#14264d}
    .btn:active{transform:translateY(1px)}
    .btn.cancel{background:rgba(239,68,68,.15); color:#fecaca; border-color:rgba(239,68,68,.35)}
    .btn.cancel:hover{background:rgba(239,68,68,.25)}
    .btn.ok{background:rgba(16,185,129,.15); color:#bbf7d0; border-color:rgba(16,185,129,.35)}
    .btn.ok:hover{background:rgba(16,185,129,.25)}
    .btn[disabled]{opacity:.55; cursor:not-allowed}

    .toast{position:fixed; right:20px; bottom:20px; background:#0b152a; color:#e5e7eb;
      border:1px solid var(--line); padding:10px 12px; border-radius:10px;
      box-shadow:0 10px 24px rgba(0,0,0,.35); opacity:0; transform:translateY(10px); transition:all .2s ease; z-index:50}
    .toast.show{opacity:1; transform:translateY(0)}
    .subtle{color:var(--muted); font-size:12px; margin-top:10px}
  </style>
</head>
<body>

  <!-- Header -->
  <header>
    <div class="wrap">
      <div class="row">
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div>
            <h1>{{ brand_name }} — Appointments</h1>
            <div class="subtle">Today: <strong>{{ today }}</strong></div>
          </div>
        </div>

        <div class="controls">
          <!-- status filter -->
          <div class="seg" id="statusSeg" aria-label="Status filter">
            <a href="#" data-status="all" class="active">All</a>
            <a href="#" data-status="Scheduled">Scheduled</a>
            <a href="#" data-status="Completed">Completed</a>
            <a href="#" data-status="Cancelled">Cancelled</a>
          </div>

          <!-- today/all -->
          <div class="seg" aria-label="Date scope">
            <a class="{{ 'active' if view=='today' else '' }}" href="/admin?view=today">Today</a>
            <a class="{{ 'active' if view!='today' else '' }}" href="/admin?view=all&status=all">All</a>
          </div>

          <!-- search -->
          <label class="search" aria-label="Search">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M21 21l-4.3-4.3m1.6-5.4a7 7 0 11-14 0 7 7 0 0114 0z"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <input id="q" type="search" placeholder="Search name, email, service…" />
          </label>

          <!-- quick links -->
          <a class="link" href="/" target="_blank" rel="noopener">View site</a>
          <a class="link" href="/logout">Logout</a>
        </div>
      </div>
    </div>
  </header>

  <!-- Stat cards -->
  <section class="stats" id="stats">
    <div class="card"><h3>Scheduled</h3><div class="num" id="nScheduled">0</div></div>
    <div class="card"><h3>Completed</h3><div class="num" id="nCompleted">0</div></div>
    <div class="card"><h3>Cancelled</h3><div class="num" id="nCancelled">0</div></div>
    <div class="card"><h3>Total</h3><div class="num" id="nTotal">0</div></div>
  </section>

  <!-- Table -->
  <main>
    {% if rows|length == 0 %}
      <div class="card" style="padding:24px;text-align:center">No appointments found.</div>
    {% else %}
    <table class="table" id="tbl">
      <thead>
        <tr>
          <th data-col="date">Date <span class="sort">⇅</span></th>
          <th data-col="time">Time <span class="sort">⇅</span></th>
          <th data-col="name">Name <span class="sort">⇅</span></th>
          <th data-col="service">Service <span class="sort">⇅</span></th>
          <th data-col="email">Email <span class="sort">⇅</span></th>
          <th data-col="status">Status <span class="sort">⇅</span></th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="body">
        {% for r in rows %}
        <tr data-id="{{ r.id }}" data-status="{{ r.status or 'Scheduled' }}">
          <td data-key="date">{{ r.date }}</td>
          <td data-key="time">{{ r.time }}</td>
          <td data-key="name">{{ r.name }}</td>
          <td data-key="service">{{ r.service }}</td>
          <td data-key="email" class="muted">{{ r.email or "" }}</td>
          <td class="status">
            {% set s = (r.status or "Scheduled") %}
            <span class="badge {% if s=='Cancelled' %}cancelled{% elif s=='Completed' %}completed{% endif %}">{{ s }}</span>
          </td>
          <td class="actions">
            <button class="btn ok complete">Complete</button>
            <button class="btn cancel cancelBtn">Cancel</button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% endif %}
  </main>

  <div class="wrap"><div class="subtle">View: <strong>{{ view }}</strong></div></div>
  <div class="toast" id="toast" role="status" aria-live="polite">Saved</div>

  <script>
    // --- helpers ---
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const CSRF = "{{ csrf }}";  // from Flask session
    const toast = (msg) => { const t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1600); };

    async function postJSON(url){
      try{
        const res = await fetch(url, { method:'POST', headers:{ 'X-CSRF-Token': CSRF } });
        if(!res.ok){
          const txt = await res.text().catch(()=> '');
          console.error('POST failed', res.status, txt);
          if(res.status===403) toast('Session expired (CSRF). Refresh.');
          else toast('Action failed');
          return null;
        }
        return res.json();
      }catch(e){
        console.error(e); toast('Network error'); return null;
      }
    }

    // counts
    function refreshCounts(){
      const rows = $$('#body tr');
      const totals = {Scheduled:0, Completed:0, Cancelled:0};
      rows.forEach(r => { totals[r.dataset.status] = (totals[r.dataset.status]||0) + 1; });
      $('#nScheduled').textContent = totals.Scheduled || 0;
      $('#nCompleted').textContent = totals.Completed || 0;
      $('#nCancelled').textContent = totals.Cancelled || 0;
      $('#nTotal').textContent = rows.length;
    }
    refreshCounts();

    // filters
    const q = $('#q'); const statusSeg = $('#statusSeg'); let activeStatus='all';
    const applyFilters = () => {
      const term = (q.value||'').toLowerCase();
      $$('#body tr').forEach(tr=>{
        const statusOk = (activeStatus==='all') || (tr.dataset.status===activeStatus);
        const text = [
          tr.querySelector('[data-key="name"]').textContent,
          tr.querySelector('[data-key="email"]').textContent,
          tr.querySelector('[data-key="service"]').textContent
        ].join(' ').toLowerCase();
        const searchOk = !term || text.includes(term);
        tr.style.display = (statusOk && searchOk) ? '' : 'none';
      });
    };
    q.addEventListener('input', applyFilters);
    statusSeg.addEventListener('click', e=>{
      const a = e.target.closest('a'); if(!a) return; e.preventDefault();
      $$('#statusSeg a').forEach(x=>x.classList.remove('active'));
      a.classList.add('active'); activeStatus = a.dataset.status; applyFilters();
    });

    // sorting
    let sortState = {col:'date', dir:1};
    const cmp = (a,b) => (a>b) - (a<b);
    function sortBy(col){
      const rows = $$('#body tr');
      rows.sort((r1,r2)=>{
        let v1 = r1.querySelector(`[data-key="${col}"]`)?.textContent || '';
        let v2 = r2.querySelector(`[data-key="${col}"]`)?.textContent || '';
        return sortState.dir * cmp(v1.toLowerCase(), v2.toLowerCase());
      }).forEach(r => r.parentNode.appendChild(r));
      sortState = {col, dir:(sortState.col===col ? -sortState.dir : 1)};
    }
    $$('#tbl thead th[data-col]').forEach(th=> th.addEventListener('click', ()=> sortBy(th.dataset.col)));

    // actions
    function setStatus(tr, s){
      const badge = tr.querySelector('.status .badge');
      tr.dataset.status = s;
      badge.textContent = s;
      badge.className = 'badge';
      if(s==='Completed') badge.classList.add('completed');
      if(s==='Cancelled') badge.classList.add('cancelled');

      // disable buttons if not Scheduled
      const cancelBtn = tr.querySelector('.cancelBtn');
      const completeBtn = tr.querySelector('.complete');
      const disabled = s !== 'Scheduled';
      cancelBtn.disabled = disabled;
      completeBtn.disabled = disabled;

      refreshCounts(); applyFilters();
    }

    $$('#body tr').forEach(tr=>{
      const id = tr.dataset.id;
      // initialize disabled state for non-Scheduled rows
      setStatus(tr, tr.dataset.status);

      tr.querySelector('.cancelBtn').addEventListener('click', async ()=>{
        if(tr.dataset.status !== 'Scheduled') return;
        if(!confirm('Cancel this appointment?')) return;
        const j = await postJSON(`/admin/api/cancel/${id}`);
        if(j && j.changed){ setStatus(tr,'Cancelled'); toast('Cancelled'); }
      });

      tr.querySelector('.complete').addEventListener('click', async ()=>{
        if(tr.dataset.status !== 'Scheduled') return;
        if(!confirm('Mark as completed?')) return;
        const j = await postJSON(`/admin/api/complete/${id}`);
        if(j && j.changed){ setStatus(tr,'Completed'); toast('Completed'); }
      });
    });
  </script>
</body>
</html>
